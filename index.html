<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Text Extraction</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
</head>
<body>
    <h2 id="bookTitle"></h2>
    <canvas id="coverImage"></canvas>
    <input type="file" id="file-input" />
    <pre id="pdf-content"></pre>
    <h2 id="speedWords">speed read text will display here</h2>
    
    

    <button onclick="stepBackward()">/-</button>
    <button onclick="stepForward()">-></button>
    <button onclick="toggle()">PLAY</button>  

    <button onclick="getBookmark(selectedBook)">Load Bookmark</button>
    <button onclick="setBookmark(selectedBook, wordIndex, 1)">Save Bookmark</button>

    <p>Reading Speed</p>
    <input type="range" min="100" max="1000" value="500" class="slider" id="speedSlider">
    <p>Value: <span id="speedValue">50</span></p>

    <p>Place</p>
    <input type="range" min="0" max="100" value="0" class="slider" id="placeSlider" disabled>
    <p>Value: <span id="placeValue">50</span></p>


    <script>

        
        

        var titleElement = document.getElementById('bookTitle');


        let wordsAtATime = 5;
        let wordIndex = 0;
        const locationName = "splitBook";

        let wordInterval = 200;

        let isPlaying = false;

        let selectedBook = "No Book Selected";
        let pastBooks = {};

         // Set the text content of the <h2> element using JavaScript
        titleElement.textContent = selectedBook;




            // For speed slider
        var slider = document.getElementById("speedSlider");
        
        // Get the value display element
        var sliderValueDisplay = document.getElementById("speedValue");

        // Initial display of the slider value
        sliderValueDisplay.textContent = slider.value;

        // Update the value display as the slider is moved
        slider.addEventListener("input", function() {
            sliderValueDisplay.textContent = slider.value;

            // Update your JavaScript variable here
            var modifiedVariable = slider.value;
            console.log("Modified variable:", modifiedVariable);
            
            wordInterval = slider.value;
            // You can use 'modifiedVariable' for further operations
        });


        function updatePlaceSlider()
        {
            let storedArray = JSON.parse(sessionStorage.getItem(locationName));
            let length = storedArray.length;

            let placeSlideVal = (wordIndex / length) * 100;
            
            var slider = document.getElementById("placeSlider");
            slider.value = placeSlideVal;

            var output = document.getElementById("placeValue");
            output.innerHTML = wordIndex;

        }

        function toggle() {
            if (!isPlaying) { play()}
            else {stop()}
        }

        

        function setBookmark(cookieName, cookieValue, expirationDays) {
            const d = new Date();
            d.setTime(d.getTime() + (expirationDays * 24 * 60 * 60 * 1000));
            const expires = "expires=" + d.toUTCString();
            document.cookie = cookieName + "=" + cookieValue + ";" + expires + ";path=/";
        }

        function getBookmark(cookieName) {
            console.log(cookieName);

            const name = cookieName + "=";
            const decodedCookie = decodeURIComponent(document.cookie);
            const cookieArray = decodedCookie.split(';');
            for(let i = 0; i < cookieArray.length; i++) {
                let cookie = cookieArray[i];
                while (cookie.charAt(0) === ' ') {
                    cookie = cookie.substring(1);
                }
                if (cookie.indexOf(name) === 0) {
                    // Extract the value part (which is a number)
                    var valueString = cookie.substring(name.length); // +1 to skip '='
                    console.log(valueString);

                    // Convert the string value to a number
                    wordIndex = parseInt(valueString);
                    
                }
            }

            console.log("word index: " + wordIndex);
            loadWords(1,0);
            
        }

        function play() {
            if (!isPlaying) {
                
                isPlaying = true;
                blinkInterval = setInterval(() => {
                    console.log("played");
                    stepForward();
                }, wordInterval);
            }
        }

        function stop() {
            if (isPlaying) {
                clearInterval(blinkInterval);
                isPlaying = false;
            }
        }

        function stepForward() {
            let storedArray = JSON.parse(sessionStorage.getItem(locationName));
            console.log(storedArray[wordIndex]);
            
            loadWords(1, 0);

            wordIndex += wordsAtATime;
        }

        function stepBackward() {
            let storedArray = JSON.parse(sessionStorage.getItem(locationName));
            console.log(storedArray[wordIndex]);
            
            loadWords(-1, 0);

            wordIndex -= wordsAtATime;
        }

        function loadWords(direction, jump) {
            let storedArray = JSON.parse(sessionStorage.getItem(locationName));

            // Select the <h2> element by its ID
            let heading = document.getElementById('speedWords');
            let newWords = "";

            for (let i = 0; i < wordsAtATime; i++) {
                if (wordIndex + (i * jump) + (i * direction) < storedArray.length && wordIndex + (i * direction) >= 0) {
                    newWords += storedArray[wordIndex + (i * jump) + (direction * i)] + " ";
                }
            }

            // Replace the text content of the <h2> element
            console.log(newWords);
            if (newWords != null && newWords != "") 
            {
                heading.textContent = newWords.trim();
            }

            updatePlaceSlider();

            console.log(wordIndex);
                
        }

        document.getElementById('file-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file.type !== 'application/pdf') {
                alert('Please select a PDF file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const typedArray = new Uint8Array(e.target.result);
                displayCoverPage(typedArray);

                pdfjsLib.getDocument(typedArray).promise.then(function(pdf) {
                    
                    
                    
                    let textContent = '';

                    const numPages = pdf.numPages;
                    let pagePromises = [];

                    for (let pageNum = 1; pageNum <= numPages; pagePromises.push(pdf.getPage(pageNum)), pageNum++);

                    Promise.all(pagePromises).then(pages => {
                        let textPromises = [];

                        for (let page of pages) {
                            textPromises.push(page.getTextContent().then(function(textContent) {
                                return textContent.items.map(function(item) {
                                    return item.str;
                                }).join(' ');
                            }));
                        }

                        Promise.all(textPromises).then(texts => {
                            textContent = texts.join(' ');
                            let strArray = textContent.split(/\s+/);
                            sessionStorage.setItem(locationName, JSON.stringify(strArray));

                            // Retrieving the array
                            let storedArray = JSON.parse(sessionStorage.getItem(locationName));
                            console.log(storedArray[0]);
                        });
                    });
                });
            };

            reader.readAsArrayBuffer(file);
            loadWords();
            wordIndex = 0;
        });

        function displayCoverPage(pdfData) {
            const input = document.getElementById('file-input');
            selectedBook = input.files[0].name;
            titleElement.textContent = selectedBook;
            

            // Load PDF document
            pdfjsLib.getDocument(pdfData).promise.then(function(pdf) {
                // Fetch the first page
                pdf.getPage(1).then(function(page) {
                    const viewport = page.getViewport({ scale: 1 });
                    const canvas = document.getElementById('coverImage');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    // Render PDF page into canvas context
                    page.render({
                        canvasContext: context,
                        viewport: viewport
                    });
                });
            });
        }
    </script>
</body>
</html>
