<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Text Extraction</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <style>


        
        html, body {margin: 0; height: 100%; overflow: hidden}
        
        body {
            background-color: #6ab5ff;

            --bg-color: background-color: #7f5a83;
            background-image: linear-gradient(315deg, #292c46 0%, #274f6c 74%);
            --menu-color: #00000045;
            --lyrics-color: white;
            --font-family: "Montserrat",sans-serif;
        
        }
        #pdf-content {
            height: 150px;
            overflow: auto;
            background-color: #f1f1f1;
            padding: 10px;
            border: 1px solid #ddd;
        }
        .slider {
            width: 50%;
            height: 1px;
            background-color: #46de4e;
        }
        .controls {
            margin-top: 20px;
        }
        .bookmarks {
            margin-top: 20px;
        }

        #textContainer {
            border: 1px solid #ddd;
            border-radius: 10px;

            margin-left: 30px;
            margin-right: 30px;
            margin-top: 30px;
            margin-bottom: 30px;
            background-color: white;

            width: 100%;
            max-width: 600px; /* Optional: max width to prevent it from getting too wide */
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
        }

        


        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            background: #ffffff;
            cursor: pointer;
        }

        

        .slider::-moz-range-thumb {
        width: 1px;
        height: 15px;
        background: #ffffff;
        border-color: rgb(232, 232, 232);
        cursor: pointer;
        }



        .note {
            font-family:'Courier New', Courier, monospace; /* Choose your preferred font */
            font-size: 50px; /* Adjust the font size as needed */
            font-weight: bold; /* Make the text bold */
            color: white; /* White fill for the text */
            text-shadow:
                -1px -1px 0 #000,  
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000; /* Black outline effect */
        }

        .controls {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .controls button {
            font-family: 'Courier New', Courier, monospace; /* Use a monospace font */
            font-size: 45px; /* Adjust font size as needed */
            width: 120px; /* Adjust button size */
            height: 120px; /* Adjust button size */
            border-radius: 50%; /* Make the buttons circular */
            font-weight: bolder;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

            /* Style for the footer */
    footer {
        position: fixed; /* Fixed positioning */
        bottom: 0; /* Stick to the bottom */
        width: 100%; /* Full width */
        text-align: center; /* Center align text */
        padding: 10px 0; /* Padding */
    }

    /* Style for the h1 and p tags inside the footer */
    footer h1, footer p {
        color: white; /* Text color */
        font-size: 10px; /* Font size */
        margin: 0; /* Remove default margins */
    }

        

        
    </style>

</head>
<body >
    
    
    
    
    
    
    
    <div style=" text-align: center; ">
        <div class="container" style="display: flex; flex-direction: column; align-items: center;">
    
            <div id="textContainer" style="margin-top: 50px;  min-width: 400px; margin-bottom: 50px;">
                
                <h2 id="lastWords" class="text-center" style="margin-top: 40px; margin-bottom: 40px; margin-right: 10px; margin-left: 10px; white-space: nowrap; font-size: clamp(1rem, 2.5vw, 2rem); color: rgb(159, 159, 159);">Last piece of text goes here</h2>

                <h2 id="speedWords" class="text-center" style="margin-top: 40px; margin-bottom: 40px; margin-right: 10px; margin-left: 10px; white-space: nowrap; font-size: clamp(1rem, 2.5vw, 2rem);  color: rgb(0, 0, 0);">Curent piece of text goes here</h2>
                
                <h2 id="nextWords" class="text-center" style="margin-top: 40px; margin-bottom: 40px; margin-right: 10px; margin-left: 10px; white-space: nowrap; font-size: clamp(1rem, 2.5vw, 2rem);  color: rgb(159, 159, 159);">Next piece of text goes here</h2>
            </div>
    
            
    
            


            <div class="controls-container" style="width: 100vw; background-color: #0000006e;">
                <div class="row" style="display: block; text-align: center; margin-top: 15px;">
                    <p id="bookTitle" style="color: white; font-size: 13px;">No book uploaded</p>
                </div>
                
                <div class="row" style="display: block; text-align: center; ">
                    
                    <div style="display: inline-block; text-align: center; ">
                        <p id="placeValue" style="display: inline-block; vertical-align: middle; margin: 0 15px; width: 30px; color: white;">0</p>
                        <input type="range" min="0" max="100" value="0" class="slider" id="placeSlider" disabled style="display: inline-block; vertical-align: middle; margin: 0 15px; background-color: white;">
                        <p id="placeDestination" style="display: inline-block; vertical-align: middle; margin: 0 15px; width: 30px; color: white;">0</p>
                    </div>

                </div>
                
                <div class="controls row" style="margin-bottom: 20px; text-align: center;">
                    
                    
                    <button id="backstep" class="btn btn-primary mx-1" style="background-color: #00000000; border-width: 1px;" onclick="stepBackward()">|&#x25C0;</button>
                    <button id="play" class="btn btn-success mx-1" style="background-color: #00000000; border-width: 4px;" onclick="toggle()">&#x25B6;</button>
                    <button id="forwardstep" class="btn btn-primary mx-1" style="background-color: #00000000; border-width: 1px;" onclick="stepForward()">&#x25B6;|</button>
                </div>

                <div class="row" style="margin-bottom: 20px; text-align: center; display: flex; justify-content: center; align-items: center; height: 100%;">
                    <button class="btn btn-primary" data-toggle="modal" data-target="#settingsModal" style="margin-bottom: 20px;">
                        Settings
                    </button>
                    
                    <button class="btn btn-success" data-toggle="modal" data-target="#uploadModal" style="margin-bottom: 20px; margin-left: 25px;">
                        Upload
                    </button>
                </div>

                
            </div>

            
        
            <!-- Settings Modal -->
            <div class="modal fade" id="settingsModal" tabindex="-1" role="dialog" aria-labelledby="settingsModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="settingsModalLabel">Settings</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                           

    
                            <div class="bookmarks text-center" style="margin-top: 20px; display: flex;">
                                <button class="btn btn-info mx-1" onclick="getBookmark(selectedBook)">Load Bookmark</button>
                                <button class="btn btn-info mx-1" onclick="setBookmark(selectedBook, wordIndex, 1)">Save Bookmark</button>
                            </div>
                    

                        
                            
                    
                            <div style="text-align: center; margin-top: 20px;">
                                <p style="display: inline-block; margin-right: 10px;">Reading Speed :</p>
                                <p style="display: inline-block; margin-right: 10px;"><span id="speedValue">500</span></p>
                                <input type="range" min="100" max="1000" value="500" class="slider" id="speedSlider">
                            </div>

                            <div style="text-align: center; margin-top: 20px;">
                                <p style="display: inline-block; margin-right: 10px;">Words At A Time :</p>
                                <p style="display: inline-block; margin-right: 10px;"><span id="wordValue">500</span></p>
                                <input type="range" min="1" max="8" value="500" class="slider" id="wordSlider">
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <!-- Additional buttons if needed -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Modal -->
            <div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="settingsModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="settingsModalLabel">Upload</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                           
                            <img id="coverImage" src="default.png" width="200px" height="200px"></img>
                    
                            <div style="text-align: center; margin-top: 20px;">
                                
                                <!--<p> Drag and drop PDF or</p>-->
                                <label for="file-input" class="btn btn-success">
                                    Click to Upload <input type="file" id="file-input" accept=".pdf" style="display: none;">
                                </label>
                            </div>

                        
                            

                        </div>
                        <div class="modal-footer">
                            
                           
                            
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <!-- Additional buttons if needed -->
                        </div>
                    </div>
                </div>
            </div>
            

    
        </div>
    </div>
    
    
    <footer style="text-align: center; margin-top: 20px;">
        <h1 style="color: white; font-size: 10px;">Speedy.io</h1>
        <p style="color: white; font-size: 10px;">A Speed Reading tool created by Jack Gardner</p>
        
        <div style="grid-row: span; font-size: 10px;">
            <a href="https://www.linkedin.com/in/jack-gardner-bab759223">Linkedin</a>
            
            <a href="https://github.com/jacknelsongardner">Github</a>
        </div>
        
    </footer>


    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


    <script>

        // Function to be called when a key is pressed
        function keyPressed(event) {
            
            console.log(event.key);
            // Check if the 'Enter' key is pressed
            if (event.key === 'Space') {
                toggle();
            }
            else if (event.key === 'Left')
            {
                stepBackward();
            }
            else if (event.key === 'Right')
            {
                stepForward();
            }
        }

        // Add an event listener to the document
        document.addEventListener('keydown', keyPressed);

        function adjustFontSize() {
            const container = document.getElementById('textContainer');
            const lastText = document.getElementById('lastWords');
            const nextText = document.getElementById('nextWords');
            
            const containerWidth = container.offsetWidth;
            const textWidth = lastText.scrollWidth; // Use scrollWidth to get full width including overflow
            
            // Get current font size
            let fontSize = parseFloat(window.getComputedStyle(lastText, null).getPropertyValue('font-size'));
            
            // Calculate scale factor
            const scale = containerWidth / textWidth;
            
            // Adjust font size based on scale
            fontSize *= scale;
            
            // Limit font size to not exceed the container width
            const maxFontSize = parseFloat(window.getComputedStyle(container, null).getPropertyValue('font-size'));
            fontSize = Math.min(fontSize, maxFontSize);
            
            // Apply the new font size
            lastText.style.fontSize = fontSize + 'px';
            nextText.style.fontSize = fontSize + 'px';
        }

        // Call adjustFontSize initially and on window resize
        adjustFontSize();
        window.addEventListener('resize', adjustFontSize);

        
        



        var titleElement = document.getElementById('bookTitle');


        let wordsAtATime = 5;
        let wordIndex = 0;
        const locationName = "splitBook";

        let wordInterval = 500;

        let isPlaying = false;

        let selectedBook = "No Book Selected";
        let pastBooks = {};

        let wpm = 500;




            // For speed slider
        var speedSlider = document.getElementById("speedSlider");
        
        // Get the value display element
        var speedValueDisplay = document.getElementById("speedValue");

        // Initial display of the slider value
        speedValueDisplay.textContent = speedSlider.value;


        speedSlider.addEventListener("input", function() {
            speedValueDisplay.textContent = speedSlider.value;
            let modifiedSpeed = speedSlider.value;
            wpm = modifiedSpeed;
            wordInterval = (60000 / wpm) * wordsAtATime;
            updateSlideDisplay();
        });

        // For word slider
        var wordSlider = document.getElementById("wordSlider");
        var wordValueDisplay = document.getElementById("wordValue");

        // Initial display of the slider value
        wordValueDisplay.textContent = wordSlider.value;

        wordSlider.addEventListener("input", function() {
            wordValueDisplay.textContent = wordSlider.value;
            let modifiedWords = wordSlider.value;
            let num = parseInt(modifiedWords);
            wordsAtATime = num;
            wordInterval = (60000 / wpm) * wordsAtATime;
            updateSlideDisplay();
        });

        function updateSlideDisplay() {
            // Example: Update some display or perform other operations
            let speedDisplay = document.getElementById("speedValue");
            speedDisplay.textContent = wpm; // Update displayed value

            let wordDisplay = document.getElementById("wordValue");
            

            wordDisplay.textContent = wordsAtATime; // Update displayed value
        }


        function updatePlaceSlider()
        {
            let storedArray = JSON.parse(sessionStorage.getItem(locationName));
            let length = storedArray.length;

            let placeSlideVal = (wordIndex / length) * 100;
            
            var slider = document.getElementById("placeSlider");
            slider.value = placeSlideVal;

            var output = document.getElementById("placeValue");
            output.innerHTML = wordIndex;

            

            var end = document.getElementById("placeDestination");
            end.innerHTML = length - wordIndex;
        }

        function toggle() {
            if (!isPlaying) { 
                play(); 
                let button = document.getElementById("play");
                button.textContent = "||";
            }
            else {
                stop();
                let button = document.getElementById("play");
                button.textContent = "\u25B6";
            }
        }

        

        function setBookmark(cookieName, cookieValue, expirationDays) {
            stop();
            const d = new Date();
            d.setTime(d.getTime() + (expirationDays * 24 * 60 * 60 * 1000));
            const expires = "expires=" + d.toUTCString();
            document.cookie = cookieName + "=" + cookieValue + ";" + expires + ";path=/";
        }

        function getBookmark(cookieName) {
            stop();
            
            console.log(cookieName);

            const name = cookieName + "=";
            const decodedCookie = decodeURIComponent(document.cookie);
            const cookieArray = decodedCookie.split(';');
            for(let i = 0; i < cookieArray.length; i++) {
                let cookie = cookieArray[i];
                while (cookie.charAt(0) === ' ') {
                    cookie = cookie.substring(1);
                }
                if (cookie.indexOf(name) === 0) {
                    // Extract the value part (which is a number)
                    var valueString = cookie.substring(name.length); // +1 to skip '='
                    console.log(valueString);

                    // Convert the string value to a number
                    wordIndex = parseInt(valueString);
                    
                }
            }

            console.log("word index: " + wordIndex);
            loadWords(1,0);
            
        }

        function play() {
            if (!isPlaying) {
                
                isPlaying = true;
                blinkInterval = setInterval(() => {
                    console.log("played");
                    
                    let storedArray = JSON.parse(sessionStorage.getItem(locationName));
                    console.log(storedArray[wordIndex]);
                    
                    wordIndex += wordsAtATime;
                    loadWords(1, 0);
                    
                }, wordInterval);
            }
        }

        function stop() {
            if (isPlaying) {
                clearInterval(blinkInterval);
                isPlaying = false;
            }
        }

        function stepForward() {
            stop();
            let storedArray = JSON.parse(sessionStorage.getItem(locationName));
            console.log(storedArray[wordIndex]);
            
            wordIndex += wordsAtATime;
            loadWords(1, 0);

        }

        function stepBackward() {
            stop();
            let storedArray = JSON.parse(sessionStorage.getItem(locationName));
            console.log(storedArray[wordIndex]);
            
            wordIndex -= wordsAtATime;
            loadWords(1, 0);

        }

        function loadWords(direction, jump) {
            let storedArray = JSON.parse(sessionStorage.getItem(locationName));

            // Select the <h2> element by its ID
            let last = document.getElementById('lastWords');
            let current = document.getElementById('speedWords');
            let next = document.getElementById('nextWords');

            let newWords = "";

        

            for (let i = 0; i < wordsAtATime; i++) {
                if (wordIndex + (i * jump) + (i * direction) < storedArray.length && wordIndex + (i * direction) >= 0) {
                    newWords += storedArray[wordIndex + (i * jump) + (direction * i)] + " ";
                }
            }

            // Replace the text content of the <h2> element
            console.log(newWords);
            if (newWords != null && newWords != "") 
            {
                current.textContent = newWords.trim();
            }
            else { last.textContent = "..."}

            newWords = "";

            // Setting last words
            if (wordIndex - wordsAtATime >= 0) {
                for (let i = 0; i < wordsAtATime; i++) {
                    if (wordIndex + (i * jump) + (i * direction) < storedArray.length && wordIndex + (i * direction) >= 0) {
                        newWords += storedArray[(wordIndex - wordsAtATime) + (i * jump) + (direction * i)] + " ";
                    }
                }
            }
            
            // Replace the text content of the <h2> element
            console.log(newWords);
            if (newWords != null && newWords != "") 
            {
                last.textContent = newWords.trim();
            }
            else { last.textContent = "..."}


            newWords = "";

            // Setting last words
            if (wordIndex + wordsAtATime < storedArray.length) {
                for (let i = 0; i < wordsAtATime; i++) {
                    if (wordIndex + (i * jump) + (i * direction) < storedArray.length && wordIndex + (i * direction) >= 0) {
                        newWords += storedArray[(wordIndex + wordsAtATime) + (i * jump) + (direction * i)] + " ";
                    }
                }
            }
            
            // Replace the text content of the <h2> element
            console.log(newWords);
            if (newWords != null && newWords != "") 
            {
                next.textContent = newWords.trim();
            }
            else { next.textContent = "..."}



            updatePlaceSlider();

            console.log(wordIndex);
                
        }

        document.getElementById('file-input').addEventListener('change', function(event) {
            console.log("recieved file");
            
            const file = event.target.files[0];
            if (file.type !== 'application/pdf') {
                alert('Please select a PDF file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const typedArray = new Uint8Array(e.target.result);
                console.log(typedArray);
                
                displayCoverPage(typedArray);

                pdfjsLib.getDocument(typedArray).promise.then(function(pdf) {
                    
                    
                    
                    let textContent = '';

                    const numPages = pdf.numPages;
                    let pagePromises = [];

                    for (let pageNum = 1; pageNum <= numPages; pagePromises.push(pdf.getPage(pageNum)), pageNum++);

                    Promise.all(pagePromises).then(pages => {
                        let textPromises = [];

                        for (let page of pages) {
                            textPromises.push(page.getTextContent().then(function(textContent) {
                                return textContent.items.map(function(item) {
                                    return item.str;
                                }).join(' ');
                            }));
                        }

                        Promise.all(textPromises).then(texts => {
                            textContent = texts.join(' ');
                            let strArray = textContent.split(/\s+/);
                            sessionStorage.setItem(locationName, JSON.stringify(strArray));
                            
                            console.log(locationName);
                            console.log(strArray);

                            // Retrieving the array
                            let storedArray = JSON.parse(sessionStorage.getItem(locationName));
                            console.log(storedArray[0]);
                        });
                    });
                });

                
                
            };

            reader.readAsArrayBuffer(file);

            // Set a timer to execute a function after a specified delay
            const timer = setTimeout(function() {
                console.log("Timer finished");
            }, 1000); // 5000 milliseconds = 5 seconds

            // Function to stop the timer suddenly
            function stopTimer() {
                clearTimeout(timer);
                console.log("Timer stopped suddenly");
            }

            // Call stopTimer at some point before the timer finishes
            setTimeout(stopTimer, 500); // This will stop the timer after .5 seconds

            wordIndex = 0;

            loadWords(1,0);
        });

        
        function displayCoverPage(pdfData) {
            
            const input = document.getElementById('file-input');
            selectedBook = input.files[0].name;
            
            let titleElement = document.getElementById("bookTitle");
            titleElement.textContent = selectedBook;
            
            

            // Load PDF document
            pdfjsLib.getDocument(pdfData).promise.then(function(pdf) {
                // Fetch the first page
                pdf.getPage(1).then(function(page) {
                    const viewport = page.getViewport({ scale: 1 });
                    
                    // Create a canvas element
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    // Render the PDF page into the canvas context
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };

                    page.render(renderContext).promise.then(function() {
                        // Convert the canvas to an image
                        const image = document.getElementById('coverImage');
                        
                        // Set the dimensions for the image
                        image.height = 200;
                        image.width = 200;
                        
                        // Set the image source to the canvas data URL
                        image.src = canvas.toDataURL();
                    });
                });
            });
            
        }
    </script>
</body>
</html>
